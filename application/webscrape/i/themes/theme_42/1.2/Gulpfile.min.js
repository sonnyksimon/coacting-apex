"use strict";!function(){var buildStart=(new Date).getTime(),coreBuild=require("../../../../internal_utilities/apex_node_build/build.js"),gulp=require("gulp"),config=require("./config.json"),gutil=require("gulp-util"),function_replacements=require("./node_modules/function_replacements.js"),sassReplacements=function_replacements.concat(require("./node_modules/less_replacements.js")),lessBuilds=[];!function(){for(var key in config.dir){var dir=config.dir[key];dir.less&&(lessBuilds.push(key),dir.paths=(dir.paths||[]).concat([[".*less/",""],[".*less-src","theme/"+key+"/less-src"]]),dir.watch=["./scss/theme/"+key+"/**/*.scss"],dir.clean=["./less/theme/"+key+"/**/*.less"],dir.outputDir="theme/",dir.cwd="./",dir.src.forEach(function(src,index,arr){arr[index]="./scss/"+arr[index]}),dir.originalSrc=dir.src,dir.src=[],dir.originalSrc.forEach(function(src){dir.src.push(src.replace(/scss/g,"less"))}),dir.override&&(dir.originalSrc.unshift("!./scss/theme/"+dir.override+"/_variables.scss"),dir.originalSrc.push("./scss/theme/"+dir.override+"/**/*.scss")))}}();var rq=coreBuild(gulp,config,{apex:{require:require}});lessBuilds.forEach(function(dir){var configDir=config.dir[dir];configDir.alterSrc=function(piped){return require("merge2")(piped,gulp.src(["less/less-src/**/*.less"],{base:"./less"}).pipe(rq("gulp-replace")(/@import.*_variables/,'@import "../theme/'+dir+"/_variables")))},configDir.buildCSS=function(vinyl){var piped=gulp.src(configDir.originalSrc),replace=rq("gulp-replace"),rename=rq("gulp-rename"),clone=rq("gulp-clone"),merge=require("merge2"),chmod=rq("gulp-chmod");piped=piped.pipe(chmod({owner:{read:!0,write:!0,execute:!0},group:{execute:!0},others:{execute:!0}}));var convertSassToLess=function(){var convert=function(piped,replacements){return replacements.forEach(function(replacement){piped=piped.pipe(replace(replacement.pattern,replacement.replacement))}),piped};convert(piped,sassReplacements),piped=piped.pipe(replace(/\.\.\/\.\.\/modules\//,"")).pipe(replace(/"variables/,'"_variables'));var concatPipe=piped.pipe(clone());return vinyl||(configDir.override&&(concatPipe=merge(convert(gulp.src("./scss/theme/"+configDir.override+"/_variables.scss"),sassReplacements),concatPipe)),merge(concatPipe,convert(gulp.src("./less/less-src/**/*.less"),function_replacements).pipe(replace(".*@import.*",""))).pipe(replace(/.*@import.*/g,"")).pipe(rq("gulp-concat")(config.dir[dir].name+".less")).pipe(gulp.dest("less/theme/"))),piped.pipe(rename({extname:".less"})).pipe(gulp.dest("./less/theme/"+dir).on("end",function(){return rq("apex").buildCSS(dir,vinyl)})),piped};if(vinyl)if("add"!==vinyl.event&&"unlink"!==vinyl.event);else if("unlink"===vinyl.event)return rq("del")([vinyl.path.replace(/scss/g,"less")]).then(convertSassToLess),piped;return convertSassToLess()},configDir.preProcessor=function(){return require("gulp-less")({compress:!0}).on("error",function(err){gutil.log(err.message)})}}),gulp.task("clean",function(){return rq("del")(["!.svn","css/**/*.css","less/theme/**/*.less","less/theme/**/*.scss"])}),gutil.log("Finished setting up UT 1.2 build. (Took "+((new Date).getTime()-buildStart)+" ms )"),gulp.task("watch-apex",function(cb){rq("browser-sync").init({proxy:{target:"myapex/apex52"}}),rq("apex").watch(cb)}),gulp.task("watch-server",function(cb){rq("gulp-watch");rq("apex").watchServer(cb)})}();